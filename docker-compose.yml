x-common-variables: &common-variables
  # Local Database (PostgreSQL)
  DATABASE_URL: postgresql://postgres:postgres@postgres:5432/v2bucket

  # Local Redis
  REDIS_URL: "redis://redis:6379"

  # Authentication Secrets
  JWT_SECRET: eZUD5Lh2All1Z1izl2EyLam3+Jtp6tUQ1BK0RtcP7sY=
  BETTER_AUTH_SECRET: nmabMgr2dRhKIPPfYeCHJaf8pdyHbZ6q5oW37GvGRqA=

  # Public URLs (HTTPS for Tailscale Funnel)
  # API and Web on same domain - API handles backend, requests pass through
  BETTER_AUTH_URL: https://v2bucket.discus-likert.ts.net
  CORS_ORIGIN: https://v2bucket.discus-likert.ts.net,http://localhost:3001
  NEXT_PUBLIC_API_URL: https://v2bucket.discus-likert.ts.net

  # Git Repository
  GIT_REPO: https://github.com/sorathiyavatsal/v2-Bucket.git
  GIT_BRANCH: main

  # Storage (path inside container)
  STORAGE_PATH: /storage

  # Tailscale Configuration
  TS_AUTHKEY: tskey-auth-km6C98WufH11CNTRL-LJKhA7xsZqEeWLeBrUPopESimLPxPoiv
  TS_HOSTNAME: v2bucket
  TS_STATE_DIR: /var/lib/tailscale

services:
  postgres:
    image: postgres:16-alpine
    container_name: v2bucket-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: v2bucket
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - v2bucket-network
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d v2bucket"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7-alpine
    container_name: v2bucket-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - v2bucket-network
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  builder:
    image: node:20-alpine
    container_name: v2bucket-builder
    working_dir: /build
    environment:
      <<: *common-variables
    volumes:
      - build-cache:/build
    networks:
      - v2bucket-network
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        set -e
        echo "Installing Git dependencies..."
        apk add --no-cache git openssh-client
        if [ ! -d /build/v2-bucket/.git ]; then
          echo "Cloning repository..."
          git clone --depth 1 --branch main https://github.com/sorathiyavatsal/v2-Bucket.git /build/v2-bucket
        else
          echo "Repository exists, pulling latest..."
          cd /build/v2-bucket
          git pull origin main
        fi
        echo "Build preparation complete"
        touch /build/.ready
        echo "Ready file created - other services can now start"
        sleep infinity
    healthcheck:
      test: ["CMD", "test", "-f", "/build/.ready"]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 300s

  api:
    image: node:20-alpine
    container_name: v2bucket-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      builder:
        condition: service_healthy
    working_dir: /app
    environment:
      <<: *common-variables
    volumes:
      - build-cache:/build:ro
      # Mount storage directory from NAS filesystem
      # Files uploaded via S3 API will be stored here and visible on the NAS
      # Change this path to match your NAS location:
      #   Synology: /volume1/docker/v2-bucket/storage
      #   QNAP: /share/Container/v2-bucket/storage
      - ./storage:/storage
    networks:
      - v2bucket-network
    ports:
      - 3000:3000
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        set -e
        echo "Installing dependencies..."
        apk add --no-cache dumb-init postgresql-client redis wget
        npm install -g pnpm@9

        echo "Testing database connection..."
        until pg_isready -h postgres -U postgres -d v2bucket; do
          echo "Database is unavailable - sleeping"
          sleep 2
        done
        echo "Database is ready!"

        echo "Testing Redis connection..."
        until redis-cli -h redis ping | grep -q "PONG"; do
          echo "Redis is unavailable - sleeping"
          sleep 2
        done
        echo "Redis is ready!"

        echo "Copying source code..."
        cp -r /build/v2-bucket/* /app/
        echo "Installing packages..."
        cd /app
        NODE_ENV=development pnpm install --frozen-lockfile
        echo "Generating Prisma client..."
        cd /app/packages/database
        pnpm exec prisma generate
        echo "Running migrations..."
        pnpm exec prisma migrate deploy
        echo "Starting API server..."
        cd /app/apps/api
        NODE_ENV=production exec dumb-init pnpm exec tsx src/index.ts
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://localhost:3000/health
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 600s

  web:
    image: node:20-alpine
    container_name: v2bucket-web
    restart: unless-stopped
    depends_on:
      builder:
        condition: service_healthy
      api:
        condition: service_healthy
    working_dir: /app
    environment:
      <<: *common-variables
      INTERNAL_API_URL: http://api:3000
      PORT: 3001
      HOSTNAME: "0.0.0.0"
    volumes:
      - build-cache:/build:ro
    networks:
      - v2bucket-network
    ports:
      - 3001:3001
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        set -e
        echo "Installing dependencies..."
        apk add --no-cache dumb-init
        npm install -g pnpm@9
        echo "Copying source code..."
        cp -r /build/v2-bucket/* /app/
        echo "Installing packages..."
        cd /app
        NODE_ENV=development pnpm install --frozen-lockfile
        echo "Generating Prisma client..."
        cd /app/packages/database
        pnpm exec prisma generate
        echo "Building Web UI..."
        cd /app/apps/web
        pnpm build
        echo "Copying static files for standalone mode..."
        cp -r /app/apps/web/.next/static /app/apps/web/.next/standalone/apps/web/.next/
        cp -r /app/apps/web/public /app/apps/web/.next/standalone/apps/web/ || true
        echo "Starting Web UI..."
        cd /app/apps/web/.next/standalone/apps/web
        exec dumb-init node server.js
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://localhost:3001
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 600s

  tailscale:
    image: tailscale/tailscale:latest
    container_name: v2bucket-tailscale
    hostname: v2bucket
    restart: unless-stopped
    privileged: true
    network_mode: host
    depends_on:
      api:
        condition: service_healthy
      web:
        condition: service_healthy
    environment:
      - TS_AUTHKEY=tskey-auth-km6C98WufH11CNTRL-LJKhA7xsZqEeWLeBrUPopESimLPxPoiv
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - tailscale-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        set -e
        echo "Starting Tailscale daemon..."
        tailscaled --state=/var/lib/tailscale/tailscaled.state &
        TAILSCALED_PID=$$!

        echo "Waiting for Tailscale to start..."
        sleep 5

        echo "Bringing up Tailscale..."
        tailscale up --authkey=$${TS_AUTHKEY} --hostname=v2bucket --accept-routes || true

        echo "Waiting for API and Web to be ready..."
        sleep 10

        echo "Configuring Tailscale Serve..."

        # Reset any existing configuration
        tailscale serve reset || true

        # Configure using the new Tailscale CLI syntax
        # Serve Web UI on root path (no path argument for root)
        echo "Setting up Web UI at root..."
        tailscale serve --bg http://127.0.0.1:3001

        # Add API routes with set-path (separate commands)
        echo "Setting up API routes..."
        tailscale serve --set-path=/api --bg http://127.0.0.1:3000

        echo "Setting up health check..."
        tailscale serve --set-path=/health --bg http://127.0.0.1:3000

        echo "Setting up metrics..."
        tailscale serve --set-path=/metrics --bg http://127.0.0.1:3000

        echo "Enabling Tailscale Funnel for public access..."
        tailscale funnel --bg 443 on

        echo "Tailscale configuration complete!"
        echo "Current serve status:"
        tailscale serve status

        echo "Waiting for tailscaled to exit..."
        wait $$TAILSCALED_PID

volumes:
  postgres-data:
    driver: local
    name: v2bucket-postgres-data
  redis-data:
    driver: local
    name: v2bucket-redis-data
  # storage-data volume removed - now using bind mount to NAS filesystem
  build-cache:
    driver: local
    name: v2bucket-build-cache
  tailscale-state:
    driver: local
    name: v2bucket-tailscale-state

networks:
  v2bucket-network:
    driver: bridge
    name: v2bucket-network
