x-common-variables: &common-variables
  # Local Database (PostgreSQL)
  DATABASE_URL: postgresql://postgres:postgres@postgres:5432/v2bucket

  # Local Redis
  REDIS_URL: "redis://redis:6379"

  # Authentication Secrets
  JWT_SECRET: eZUD5Lh2All1Z1izl2EyLam3+Jtp6tUQ1BK0RtcP7sY=
  BETTER_AUTH_SECRET: nmabMgr2dRhKIPPfYeCHJaf8pdyHbZ6q5oW37GvGRqA=

  # Public URLs
  BETTER_AUTH_URL: http://vatsal-nas.tail87f856.ts.net:3000
  CORS_ORIGIN: http://vatsal-nas.tail87f856.ts.net:3001
  NEXT_PUBLIC_API_URL: http://vatsal-nas.tail87f856.ts.net:3000

  # Git Repository
  GIT_REPO: https://github.com/sorathiyavatsal/v2-Bucket.git
  GIT_BRANCH: main

  # Storage
  STORAGE_PATH: /storage

services:
  postgres:
    image: postgres:16-alpine
    container_name: v2bucket-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: v2bucket
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - v2bucket-network
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d v2bucket"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7-alpine
    container_name: v2bucket-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - v2bucket-network
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  builder:
    image: node:20-alpine
    container_name: v2bucket-builder
    working_dir: /build
    environment:
      <<: *common-variables
    volumes:
      - build-cache:/build
    networks:
      - v2bucket-network
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        set -e
        echo "Installing Git dependencies..."
        apk add --no-cache git openssh-client
        if [ ! -d /build/v2-bucket/.git ]; then
          echo "Cloning repository..."
          git clone --depth 1 --branch main https://github.com/sorathiyavatsal/v2-Bucket.git /build/v2-bucket
        else
          echo "Repository exists, pulling latest..."
          cd /build/v2-bucket
          git pull origin main
        fi
        echo "Build preparation complete"
        sleep infinity

  api:
    image: node:20-alpine
    container_name: v2bucket-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      builder:
        condition: service_started
    working_dir: /app
    environment:
      <<: *common-variables
    volumes:
      - build-cache:/build:ro
      - storage-data:/storage
    networks:
      - v2bucket-network
    ports:
      - 3000:3000
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        set -e
        echo "Installing dependencies..."
        apk add --no-cache dumb-init postgresql-client redis wget
        npm install -g pnpm@9

        echo "Testing database connection..."
        until pg_isready -h postgres -U postgres -d v2bucket; do
          echo "Database is unavailable - sleeping"
          sleep 2
        done
        echo "Database is ready!"

        echo "Testing Redis connection..."
        until redis-cli -h redis ping | grep -q "PONG"; do
          echo "Redis is unavailable - sleeping"
          sleep 2
        done
        echo "Redis is ready!"

        echo "Copying source code..."
        cp -r /build/v2-bucket/* /app/
        echo "Installing packages..."
        cd /app
        NODE_ENV=development pnpm install --frozen-lockfile
        echo "Generating Prisma client..."
        cd /app/packages/database
        pnpm exec prisma generate
        echo "Running migrations..."
        pnpm exec prisma migrate deploy
        echo "Starting API server..."
        cd /app/apps/api
        NODE_ENV=production exec dumb-init pnpm exec tsx src/index.ts
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://localhost:3000/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  web:
    image: node:20-alpine
    container_name: v2bucket-web
    restart: unless-stopped
    depends_on:
      builder:
        condition: service_started
      api:
        condition: service_healthy
    working_dir: /app
    environment:
      <<: *common-variables
      INTERNAL_API_URL: http://api:3000
      PORT: 3001
      HOSTNAME: "0.0.0.0"
    volumes:
      - build-cache:/build:ro
    networks:
      - v2bucket-network
    ports:
      - 3001:3001
    entrypoint:
      - /bin/sh
      - -c
    command:
      - |
        set -e
        echo "Installing dependencies..."
        apk add --no-cache dumb-init
        npm install -g pnpm@9
        echo "Copying source code..."
        cp -r /build/v2-bucket/* /app/
        echo "Installing packages..."
        cd /app
        NODE_ENV=development pnpm install --frozen-lockfile
        echo "Generating Prisma client..."
        cd /app/packages/database
        pnpm exec prisma generate
        echo "Building Web UI..."
        cd /app/apps/web
        pnpm build
        echo "Copying static files for standalone mode..."
        cp -r /app/apps/web/.next/static /app/apps/web/.next/standalone/apps/web/.next/
        cp -r /app/apps/web/public /app/apps/web/.next/standalone/apps/web/ || true
        echo "Starting Web UI..."
        cd /app/apps/web/.next/standalone/apps/web
        exec dumb-init node server.js
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://localhost:3001
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  postgres-data:
    driver: local
    name: v2bucket-postgres-data
  redis-data:
    driver: local
    name: v2bucket-redis-data
  storage-data:
    driver: local
    name: v2bucket-storage-data
  build-cache:
    driver: local
    name: v2bucket-build-cache

networks:
  v2bucket-network:
    driver: bridge
    name: v2bucket-network
